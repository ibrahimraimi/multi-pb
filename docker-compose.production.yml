# Production docker-compose.yml example
# Copy this file and customize for your VPS

services:
  multi-pb:
    image: ghcr.io/multi-pb/multi-pb:latest
    # Or build from source:
    # build: .
    container_name: multi-pb
    restart: unless-stopped
    ports:
      # Option A: Behind reverse proxy (recommended)
      # Your proxy routes *.pb.yourdomain.com to this port
      - "127.0.0.1:8080:8080"
      
      # Option B: Direct exposure (multi-pb handles SSL)
      # - "80:8080"
      # - "443:8443"
    volumes:
      - /srv/multi-pb/data:/mnt/data
      - caddy_data:/data
      - caddy_config:/config
    environment:
      # Your domain - tenants will be at {name}.{DOMAIN_NAME}
      - DOMAIN_NAME=pb.yourdomain.com
      
      # Internal port
      - HTTP_PORT=8080
      
      # Enable if multi-pb handles SSL directly (not behind proxy)
      - ENABLE_HTTPS=false
      # - HTTPS_PORT=8443
      
      # Required for Let's Encrypt if ENABLE_HTTPS=true
      - ACME_EMAIL=ssl@yourdomain.com
      
      - DATA_DIR=/mnt/data
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  caddy_data:
  caddy_config:

# Example: Using with Traefik
# Add these labels instead of ports if using Traefik:
#
#    labels:
#      - "traefik.enable=true"
#      - "traefik.http.routers.multipb.rule=HostRegexp(`{subdomain:[a-z0-9-]+}.pb.yourdomain.com`)"
#      - "traefik.http.routers.multipb.entrypoints=websecure"
#      - "traefik.http.routers.multipb.tls.certresolver=letsencrypt"
#      - "traefik.http.services.multipb.loadbalancer.server.port=8080"

# Example: Using with nginx
# Add this to your nginx config:
#
#    server {
#        listen 443 ssl;
#        server_name *.pb.yourdomain.com;
#        
#        location / {
#            proxy_pass http://127.0.0.1:8080;
#            proxy_set_header Host $host;
#            proxy_set_header X-Real-IP $remote_addr;
#            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#            proxy_set_header X-Forwarded-Proto $scheme;
#        }
#    }
